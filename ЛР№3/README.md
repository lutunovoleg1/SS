## Микросервисное приложение: карты и операции

В проекте реализованы **два независимых микросервиса**:

- **Сервис карт** (`card_service.py`, SQLite `cards.db`)
- **Сервис операций** (`operation_service.py`, SQLite `operations.db`)

Каждый микросервис:

- Разворачивается как отдельное FastAPI-приложение
- Использует **свою** базу данных SQLite
- Предоставляет **REST-интерфейс** (JSON)
- Взаимодействует с другим сервисом по сети (HTTP)

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Запуск сервисов

1. **Сервис карт** (порт `8000`):

```bash
uvicorn card_service:app --reload --port 8000
```

2. **Сервис операций** (порт `8001`):

```bash
uvicorn operation_service:app --reload --port 8001
```

После запуска оба сервиса будут доступны по адресам:

- `http://localhost:8000/docs` – Swagger UI сервиса карт
- `http://localhost:8001/docs` – Swagger UI сервиса операций

### Основные эндпоинты

#### Сервис карт (`card_service.py`)

- При первом запуске, если таблица `cards` пуста, автоматически создаются **3 тестовые карты**.
- Их можно увидеть запросом **GET** `/cards`.

- **POST** `/cards` – создать карту  
  Тело запроса:

  ```json
  {
    "card_number": "1111-2222-3333-4444",
    "holder_name": "Иван Иванов",
    "balance": 1000.0,
    "activation_status": "not_activated",
    "status": "active",
    "phone_3ds": "+79990000001"
  }
  ```

- **GET** `/cards` – получить список всех карт
- **GET** `/cards/{card_id}` – получить карту по ID
- **GET** `/cards/{card_id}/summary` – сводка по карте:  
  сервис карт берет данные самой карты из своей БД и по сети запрашивает
  все операции по этой карте у `operation_service` (`GET /cards/{card_id}/operations`),
  затем возвращает единый ответ.

Дополнительные поля карт:
- `activation_status`: `"activated"` или `"not_activated"`
- `status`: `"active"`, `"blocked"` или `"closed"`
- `phone_3ds`: телефон, привязанный к 3DS

Во всех ответах API номер карты (`card_number`) возвращается **замаскированным** (видны только последние 4 цифры).

#### Сервис операций (`operation_service.py`)

- При первом запуске, если таблица `operations` пуста, автоматически создаются **несколько тестовых операций**:
  - две операции для карты с `id = 1`;
  - одна операция для карты с `id = 2`.

- **POST** `/operations` – создать операцию по карте  
  (перед вставкой сервис по сети обращается к `card_service`, проверяет, что карта существует,
  и через `PATCH /cards/{card_id}/balance` обновляет баланс карты)

  ```json
  {
    "card_id": 1,
    "amount": 250.5,
    "type": "debit"
  }
  ```

- **GET** `/operations/{operation_id}` – получить операцию по ID
- **GET** `/cards/{card_id}/operations` – получить все операции по карте

---

## Безопасность: сервис аутентификации и сервис данных

Реализованы **два микросервиса** с аутентификацией по токенам и логированием:

- **Сервис аутентификации** (`auth_service.py`, SQLite `auth.db`) — выдаёт JWT-токены.
- **Сервис данных** (`data_service.py`, SQLite `data.db`) — отдаёт данные только при валидном токене.

### Требования

- **Аутентификация**: JWT (access token), пароли хранятся в виде bcrypt-хеша.
- **Безопасный обмен**: передача токена в заголовке `Authorization: Bearer <token>`; в продакшене обязательно использовать **HTTPS**.
- **Логирование**: все запросы и попытки доступа пишутся в консоль и в файлы в папке `logs/`:
  - `logs/auth_service.log` — регистрация, вход, проверка токена (успех/неудача);
  - `logs/data_service.log` — запросы к данным, наличие токена, результат (200/401).

Общий секрет для подписи JWT задаётся переменной окружения **`JWT_SECRET`** (одинаковое значение для auth и data сервисов).

### Запуск

3. **Сервис аутентификации** (порт `8002`):

```bash
set JWT_SECRET=your-secret-key
uvicorn auth_service:app --reload --port 8002
```

4. **Сервис данных** (порт `8003`):

```bash
set JWT_SECRET=your-secret-key
uvicorn data_service:app --reload --port 8003
```

(В Linux/macOS: `export JWT_SECRET=your-secret-key`.)

- `http://localhost:8002/docs` — Swagger UI сервиса аутентификации  
- `http://localhost:8003/docs` — Swagger UI сервиса данных  

### Эндпоинты

#### Сервис аутентификации (`auth_service.py`)

- **POST** `/register` — регистрация (тело: `{"username": "...", "password": "..."}`).
- **POST** `/login` — вход, в ответе `access_token` (JWT).
- **GET** `/validate` — проверка токена (заголовок `Authorization: Bearer <token>`); другие сервисы могут вызывать этот метод для проверки токена.

#### Сервис данных (`data_service.py`)

Все методы требуют заголовок **`Authorization: Bearer <token>`** (токен с `/login`).

- **GET** `/me` — текущий пользователь по токену.
- **POST** `/documents` — создать документ (тело: `{"title": "...", "content": "..."}`).
- **GET** `/documents` — список документов.
- **GET** `/documents/{id}` — документ по ID.

Неуспешные попытки доступа (нет токена, истёкший или неверный токен) возвращают 401 и записываются в лог.

